<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessibuca HTTP-FLV ä½å»¶è¿Ÿæ’­æ”¾</title>
    <style>
        html, body {
            background: #111;
            margin: 0;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #eee;
            font-family: sans-serif;
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #container {
            width: 800px;
            height: 450px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
        }

        .control-panel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background: #0a84ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #0668d1;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.stop {
            background: #ff5555;
        }

        button.stop:hover {
            background: #cc3333;
        }

        .status {
            font-size: 14px;
            color: #aaa;
            min-height: 20px;
        }

        .status.playing {
            color: #4caf50;
        }

        .status.error {
            color: #ff5555;
        }

        .status.loading {
            color: #ffa500;
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #222;
            color: #eee;
            font-size: 13px;
            width: 320px;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h2>ğŸ¥ Jessibuca HTTP-FLV ä½å»¶è¿Ÿæ’­æ”¾</h2>

    <div>
        <select id="deviceSelect">
            <option value="">åŠ è½½ä¸­...</option>
        </select>
    </div>

    <div id="container"></div>

    <div class="control-panel">
        <button id="playBtn">â–¶ï¸ å¼€å§‹æ’­æ”¾</button>
        <button id="stopBtn" class="stop" disabled>â¹ï¸ åœæ­¢æ’­æ”¾</button>
    </div>

    <div class="status" id="status">æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</div>
</div>

<script>
    let player = null;
    let isPlaying = false;

    const deviceSelect = document.getElementById('deviceSelect');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');

    function updateStatus(message, type = 'normal') {
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
    }

    function setButtonState(playing) {
        playBtn.disabled = playing;
        stopBtn.disabled = !playing;
        isPlaying = playing;
    }

    async function checkJessibuca() {
        if (typeof Jessibuca !== 'undefined') return;
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = './jessibuca/jessibuca.min.js';
            script.onload = resolve;
            script.onerror = () => reject(new Error('æ— æ³•åŠ è½½ Jessibuca åº“'));
            document.head.appendChild(script);
        });
    }

    async function loadDeviceList() {
        try {
            updateStatus('â³ æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...', 'loading');
            const res = await fetch('/mediaStream/deviceList');
            const json = await res.json();
            if (json.code !== 200 || !Array.isArray(json.data)) throw new Error('è®¾å¤‡åˆ—è¡¨æ•°æ®é”™è¯¯');

            const devices = json.data.filter(d => d.isOnline === 1);
            deviceSelect.innerHTML = devices.length
                ? devices.map(d => `<option value="${d.deviceId}">${d.deviceId} ${d.isPush === 1 ? 'ğŸŸ¢æ¨æµä¸­' : 'ğŸŸ¡æœªæ¨æµ'}</option>`).join('')
                : '<option value="">æš‚æ— åœ¨çº¿è®¾å¤‡</option>';
            updateStatus('âœ… è®¾å¤‡åˆ—è¡¨åŠ è½½å®Œæˆ');
        } catch (err) {
            console.error(err);
            deviceSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            updateStatus('âŒ ' + err.message, 'error');
        }
    }

    async function fetchPlayUrl(playKey) {
        const response = await fetch(`/mediaStream/preview/${playKey}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });
        const result = await response.json();
        if (result.code !== 200 || !result.data?.httpFlv) throw new Error(result.msg || 'æ— å¯ç”¨æ’­æ”¾åœ°å€');
        return result.data.httpFlv; // âš ï¸ æ”¹ä¸º httpFlv åœ°å€
    }

    playBtn.onclick = async () => {
        const playKey = deviceSelect.value;
        if (!playKey) return updateStatus('âŒ è¯·é€‰æ‹©è®¾å¤‡', 'error');

        updateStatus('â³ è¯·æ±‚æ’­æ”¾åœ°å€...', 'loading');
        setButtonState(true);

        try {
            const playURL = await fetchPlayUrl(playKey);
            console.log('HTTP-FLV åœ°å€:', playURL);

            await checkJessibuca();
            if (player) player.destroy();

            player = new Jessibuca({
                container: document.getElementById('container'),
                isFlv: true,       // æ’­æ”¾ http-flv
                liveMode: true,    // ä½å»¶è¿Ÿç›´æ’­æ¨¡å¼
                videoBuffer: 0.2,  // è§†é¢‘ç¼“å†²æ—¶é—´ï¼ˆè¶Šå°å»¶è¿Ÿè¶Šä½ï¼‰
                bufferTime: 100,   // msï¼Œæ§åˆ¶è§£ç ç¼“å†²é˜Ÿåˆ—
                isResize: true,
                isFullScreen: true,
                hasAudio: true,
                showBandwidth: true,
                loadingTimeout: 10,
                decoder: "./jessibuca/decoder.js",
                debug: false,
                loadingText: "æ­£åœ¨è¿æ¥..."
            });

            player.on("play", () => updateStatus('âœ… æ­£åœ¨æ’­æ”¾', 'playing'));
            player.on("error", e => {
                updateStatus(`âŒ é”™è¯¯: ${e}`, 'error');
                setButtonState(false);
            });
            player.on("disconnect", () => {
                updateStatus('âš ï¸ è¿æ¥æ–­å¼€', 'error');
                setButtonState(false);
            });

            console.log("â–¶ï¸ å¼€å§‹æ’­æ”¾:", playURL);
            player.play(playURL);

            // Chrome è‡ªåŠ¨æ’­æ”¾ç­–ç•¥ä¼˜åŒ–
            const videoEl = document.querySelector('#container video');
            if (videoEl) {
                videoEl.muted = true; // é™éŸ³æ¨¡å¼ä¸‹å¯è‡ªåŠ¨æ’­æ”¾
                await videoEl.play().catch(() => {
                });
            }
        } catch (err) {
            console.error(err);
            updateStatus(`âŒ ${err.message}`, 'error');
            setButtonState(false);
        }
    };

    stopBtn.onclick = stopPlayback;

    async function stopPlayback() {
        if (player) player.destroy();
        player = null;
        updateStatus('å·²åœæ­¢æ’­æ”¾', 'normal');
        setButtonState(false);
    }

    window.addEventListener('beforeunload', stopPlayback);
    loadDeviceList();
</script>
</body>
</html>
