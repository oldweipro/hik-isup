<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessibuca WebSocket FLV æ’­æ”¾ç¤ºä¾‹</title>
    <style>
        html, body {
            background: #111;
            margin: 0;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #eee;
            font-family: sans-serif;
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #container {
            width: 800px;
            height: 450px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .control-panel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background: #0a84ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #0668d1;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.stop {
            background: #ff5555;
        }

        button.stop:hover {
            background: #cc3333;
        }

        .status {
            font-size: 14px;
            color: #aaa;
            min-height: 20px;
        }

        .status.playing {
            color: #4caf50;
        }

        .status.error {
            color: #ff5555;
        }

        .status.loading {
            color: #ffa500;
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #222;
            color: #eee;
            font-size: 13px;
            width: 320px;
        }

        select:focus {
            outline: none;
            border-color: #0a84ff;
            background: #2a2a2a;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h2>ğŸ¥ Jessibuca FLV WebSocket æ’­æ”¾</h2>

    <div>
        <select id="deviceSelect">
            <option value="">åŠ è½½ä¸­...</option>
        </select>
    </div>

    <div id="container"></div>

    <div class="control-panel">
        <button id="playBtn">â–¶ï¸ å¼€å§‹æ’­æ”¾</button>
        <button id="stopBtn" class="stop" disabled>â¹ï¸ åœæ­¢æ’­æ”¾</button>
    </div>

    <div class="status" id="status">æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</div>
</div>

<script>
    let player = null;
    let isPlaying = false;

    const deviceSelect = document.getElementById('deviceSelect');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');

    /** ================= å·¥å…·å‡½æ•° ================== **/
    function updateStatus(message, type = 'normal') {
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
    }

    function setButtonState(playing) {
        playBtn.disabled = playing;
        stopBtn.disabled = !playing;
        isPlaying = playing;
    }

    async function checkJessibuca() {
        if (typeof Jessibuca !== 'undefined') return;
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = './jessibuca/jessibuca.min.js';
            script.onload = resolve;
            script.onerror = () => reject(new Error('æ— æ³•åŠ è½½ Jessibuca åº“'));
            document.head.appendChild(script);
        });
    }

    /** ================= è®¾å¤‡åˆ—è¡¨ ================== **/
    async function loadDeviceList() {
        try {
            updateStatus('â³ æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...', 'loading');
            const res = await fetch('/mediaStream/deviceList');
            const json = await res.json();

            if (json.code !== 200 || !Array.isArray(json.data)) {
                throw new Error('è®¾å¤‡åˆ—è¡¨æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            }

            const devices = json.data.filter(d => d.isOnline === 1); // åªæ˜¾ç¤ºåœ¨çº¿è®¾å¤‡
            deviceSelect.innerHTML = '';

            if (devices.length === 0) {
                deviceSelect.innerHTML = '<option value="">æš‚æ— åœ¨çº¿è®¾å¤‡</option>';
                updateStatus('âš ï¸ æš‚æ— åœ¨çº¿è®¾å¤‡', 'error');
                return;
            }

            deviceSelect.innerHTML = devices.map(d =>
                `<option value="${d.deviceId}">${d.deviceId} ${d.isPush === 1 ? 'ğŸŸ¢æ¨æµä¸­' : 'ğŸŸ¡æœªæ¨æµ'}</option>`
            ).join('');

            updateStatus('âœ… è®¾å¤‡åˆ—è¡¨åŠ è½½å®Œæˆ');
        } catch (err) {
            console.error(err);
            deviceSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°</option>';
            updateStatus('âŒ åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥: ' + err.message, 'error');
        }
    }

    /** ================= è·å–æ’­æ”¾åœ°å€ ================== **/
    async function fetchPlayUrl(playKey) {
        try {
            const response = await fetch(`/mediaStream/preview/${playKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            });

            if (!response.ok) throw new Error('æ¥å£è¯·æ±‚å¤±è´¥');
            const result = await response.json();

            console.log("result:", result.data.wsFlv);
            if (result.code !== 200 || !result.data || !result.data.wsFlv) {
                throw new Error(result.msg || 'æœªè·å–åˆ°æ’­æ”¾åœ°å€');
            }

            return result.data.wsFlv;
        } catch (err) {
            throw new Error(`è¯·æ±‚å‡ºé”™: ${err.message}`);
        }
    }

    /** ================= æ’­æ”¾é€»è¾‘ ================== **/
    playBtn.onclick = async () => {
        const playKey = deviceSelect.value;
        if (!playKey) {
            updateStatus('âŒ è¯·é€‰æ‹©ä¸€ä¸ªè®¾å¤‡', 'error');
            return;
        }

        updateStatus('â³ è¯·æ±‚æ’­æ”¾åœ°å€...', 'loading');
        setButtonState(true);

        try {
            const playURL = await fetchPlayUrl(playKey);
            console.log('âœ… è·å–æ’­æ”¾åœ°å€:', playURL);

            await checkJessibuca();

            if (player) {
                player.destroy();
                player = null;
            }

            updateStatus('â³ æ­£åœ¨è¿æ¥...', 'loading');

            player = new Jessibuca({
                container: document.getElementById('container'),
                videoBuffer: 0.3,
                isResize: true,
                isFullScreen: true,
                showBandwidth: true,
                debug: false,
                decoder: "./jessibuca/decoder.js",
                bufferTime: 10000,
                liveMode: true,
                hasAudio: true,
                loadingTimeout: 20,
                isFlv: true,
                loadingText: "è¿æ¥ä¸­..."
            });

            player.on("play", () => updateStatus('âœ… æ­£åœ¨æ’­æ”¾', 'playing'));
            player.on("error", (e) => {
                updateStatus(`âŒ æ’­æ”¾é”™è¯¯: ${e}`, 'error');
                setButtonState(false);
            });
            player.on("disconnect", () => {
                updateStatus('âš ï¸ è¿æ¥å·²æ–­å¼€', 'error');
                setButtonState(false);
            });
            console.log("â–¶ï¸ å¼€å§‹æ’­æ”¾:", playURL);
            player.play(playURL);
        } catch (err) {
            console.error(err);
            updateStatus(`âŒ ${err.message}`, 'error');
            setButtonState(false);
        }
    };

    stopBtn.onclick = stopPlayback;

    function stopPlayback() {
        if (player) {
            try {
                player.destroy();
            } catch {
            }
            player = null;
        }
        updateStatus('å·²åœæ­¢æ’­æ”¾', 'normal');
        setButtonState(false);
    }

    window.addEventListener('beforeunload', stopPlayback);

    // é¡µé¢åˆå§‹åŒ–åŠ è½½è®¾å¤‡åˆ—è¡¨
    loadDeviceList();
</script>
</body>
</html>
